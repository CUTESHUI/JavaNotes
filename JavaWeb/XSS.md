## XSS

#### 简介

- 跨站脚本（cross site script）为了避免与样式 css 混淆，所以简称为 XSS
- XSS 是一种经常出现在 web 应用中的计算机安全漏洞，也是 web 中最主流的攻击方式
- XSS 是指恶意攻击者利用网站没有对用户提交数据进行转义处理或者过滤不足的缺点，进而添加一些代码，嵌入到web页面中去，使别的用户访问都会执行相应的嵌入代码
- XSS 攻击的危害是很大的，注入 script 可以执行任何的 JS 代码（意味着可以获取cookie 等信息了），注入style 可以把页面全部弄崩



#### 原理

- HTML是一种超文本标记语言，通过将一些字符特殊地对待来区别文本和标记，例如，小于符号（<）被看作是HTML标签的开始，<title>与</title>之间的字符是页面的标题等
- 当动态页面中插入的内容含有这些特殊字符（如<）时，用户浏览器会将其误认为是插入了HTML标签，当这些HTML标签引入了一段JavaScript脚本时，这些脚本程序就将会在用户浏览器中执行
- 当这些特殊字符不能被动态页面检查或检查出现失误时，就将会产生XSS漏洞



#### 攻击方式

- XSS 跟 SQL 注入是类似的，攻击有两种方式
  - 反射型
  - 存储型



#### 攻击类型

- 从攻击代码的工作方式

  - 持久型跨站

    - 最直接的危害类型，跨站代码存储在服务器（数据库）

  - 非持久型跨站

    - 反射型跨站脚本漏洞，最普遍的类型。用户访问服务器-跨站链接-返回跨站代码

  - DOM跨站（DOM XSS）
  - DOM（document object model文档对象模型），客户端脚本处理逻辑导致的安全问题



#### 防御措施

- 最重要：不要相信客户端发送过来的任何数据
- 防范XSS攻击可简单分成两个步骤
  - 编码（对特殊的字符进行编码,`<`,`'`,`>`等特殊字符）
  - 过滤（过滤掉一切可能被调用的属性，标签。比如：onclick、onerror、iframe等)
- 基于特征的防御
  - XSS 攻击和著名的 SQL注入漏洞一样，都是利用了Web页面的编写不完善，每一个漏洞所利用和针对的弱点都不尽相同，因此不能以单一特征来概括所有XSS攻击。
  - 传统的 XSS 防御在进行攻击鉴别时多采用特征匹配方式，主要是针对 “javascript” 这个关键字进行检索，但是这种鉴别不够灵活，凡是提交的信息中各有 “javascript” 时，就被硬性的被判定为 XSS 攻击
- 基于代码修改的防御
  - Web 页面开发者在编写程序时往往会出现一些失误和漏洞，XSS 攻击正是利用了失误和漏洞，因此一种比较理想的方法就是通过优化 Web 应用开发来：
    - 用户向服务器上提交的信息要对 URL 和附带的的 HTTP 头、POST 数据等进行查询，对不是规定格式、长度的内容进行过滤
    - 实现 Session 标记（session tokens）、CAPTCHA 系统或者 HTTP 引用头检查，以防功能被第三方网站所执行
    - 确认接收的的内容被妥善的规范化，仅包含最小的、安全的 Tag（没有javascript），去掉任何对远程内容的引用（尤其是样式表和javascript），使用 HTTP only 的 cookie
- 客户端分层防御策略
  - 基于独立分配线程和分层防御策略的安全模型
  - 建立在客户端（浏览器），这是它与其他模型最大的区别，之所以客户端安全性如此重要，客户端在接受服务器信息，选择性的执行相关内容这
  - 该模型主要由三大部分组成
    - 对每一个网页分配独立线程且分析资源消耗的“网页线程分析模块”
    - 包含分层防御策略四个规则的用户输入分析模块
    - 保存互联网上有关 XSS 恶意网站信息的 XSS 信息数据库

- 安全的软件开发流程及其他一些编程安全原则也可以大大减少 XSS 安全攻击的发生，这些防范 XSS 攻击原则包括：
  - 不信任用户提交的任何内容
    - 对所有用户提交内容进行可靠的输入验证，包括对URL、查询关键字、HTTP头、REFER、POST数据等，仅接受指定长度范围内、采用适当格式、采用所预期的字符的内容提交，对其他的一律过滤
    - 尽量采用 POST 而非 GET 提交表单；对“<”，“>”，“；”，“””等字符做过滤
    - 任何内容输出到页面之前都必须加以 en-code，避免不小心把 htmltag 显示出来
  - 实现Session 标记（session tokens）、CAPTCHA（验证码）系统或者 HTTP引用头检查，以防功能被第三方网站所执行
  - 对于用户提交信息的中的 img 等 link，检查是否有重定向回本站、不是真的图片等可疑操作
  - cookie 防盗
    - 避免直接在 cookie 中泄露用户隐私，例如 email、密码等
    - 通过使 cookie 和系统 IP 绑定来降低 cookie 泄露后的危险。这样攻击者得到的 cookie 没有实际价值，很难拿来直接进行重放攻击
  - 确认接收的内容被妥善地规范化
    - 仅包含最小的、安全的Tag（没有 JavaScript）
    - 去掉任何对远程内容的引用（尤其是样式表和 JavaScript），使用 HTTPonly 的 cookie。