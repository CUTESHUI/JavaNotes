## CSRF

#### 简介

- 跨站点请求伪造（Cross—Site Request Forgery）
- 是一种挟制用户在当前已登录的 Web 应用程序上执行非本意的操作的攻击方法，跟 XSS 相比，XSS 利用的是用户对指定网站的信任，CSRF 利用的是网站对用户网页浏览器的信任



#### 攻击原理及过程

- 用户C 打开浏览器，访问受信任网站A，输入用户名和密码请求登录网站A
- 在用户信息通过验证后，网站A 产生 Cookie 信息并返回给浏览器，此时用户登录网站A 成功，可以正常发送请求到网站A
- 用户未退出网站A 之前，在同一浏览器中，打开一个 TAB 页访问网站B
- 网站B 接收到用户请求后，返回一些攻击性代码，并发出一个请求要求访问第三方站点A
- 浏览器在接收到这些攻击性代码后，根据网站B 的请求，在用户不知情的情况下携带 Cookie 信息，向网站A 发出请求，网站 A 并不知道该请求其实是由 B 发起的，所以会根据用户 C 的 Cookie 信息以 C 的权限处理该请求，导致来自网站 B 的恶意代码被执行



#### 防御措施

- 检查 Referer 字段
  - HTTP 头中有一个 Referer 字段，这个字段用以标明请求来源于哪个地址。在处理敏感数据请求时，通常来说，Referer 字段应和请求的地址位于同一域名下
  - 优点：简单易行，工作量低，仅需要在关键访问处增加一步校验
  - 局限：因其完全依赖浏览器发送正确的 Referer 字段。虽然 http 协议对此字段的内容有明确的规定，但并无法保证来访的浏览器的具体实现，亦无法保证浏览器没有安全漏洞影响到此字段。并且也存在攻击者攻击某些浏览器，篡改其 Referer 字段的可能
- 添加校验 token
  - 由于 CSRF 的本质在于攻击者**欺骗用户去访问自己设置的地址**，所以如果要求在访问敏感数据请求时，要求用户浏览器提供不保存在cookie中，并且攻击者无法伪造的数据作为校验，那么攻击者就无法再运行 CSRF 攻击
  - 这种数据通常是窗体中的一个数据项，服务器将其生成并附加在窗体中，其内容是一个伪随机数
  - 当客户端通过窗体提交请求时，这个伪随机数也一并提交上去以供校验，正常的访问时，客户端浏览器能够正确得到并传回这个伪随机数，而通过 CSRF 传来的欺骗性攻击中，攻击者无从事先得知这个伪随机数的值，服务端就会因为校验 token 的值为空或者错误，拒绝这个可疑请求



