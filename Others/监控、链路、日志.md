## 监控、链路、日志

#### 背景

- 对于一个系统来说，监控、链路追踪、日志的这三者需求都是必然存在的，而有的时候我们会搞不清楚这三者相互之间是什么关系
- 没搞清楚前，做系统设计的时候就会疑惑，是不是有必要引入那么多组件，毕竟如果这三者完全分开每一个一项的话，就有三个组件了（Prometheus+Grafana、Jaeger、ELK）



#### 监控

- Monitoring（监控）举例来说就是：定期体检。使用监控系统把需要关注的指标采集起来，形成报告，并对需要关注的异常数据进行分析形成告警
- 特点
  - 低频
  - 定期
  - 定量
- Monitoring的需求并没有包含非常高的并发量和通讯量。反过来说：高并发、大数据量的需求并不适用于Monitoring这个点。



#### 链路

- Tracing（链路追踪）举例来说就是：对某一项工作的定期汇报。某个工作开始做了A，制作A事件的报告，收集起来，然后这个工作还有B、C、D等条目，一个个处理，然后都汇总进报告，最终的结果就是一个 Tracing
- 特点
  - 高频
  - 巨量
  - 有固定格式

- Tracing 是针对某一个事件（一般来说就是一个 API），而这个 API 可能会和很多组件进行沟通，后续的所有的组件沟通无论是内部还是外部的 IO，都算作这个 API 调用的 Tracing 的一部分。在一个业务繁忙的系统中，API 调用的数量已经是天文数字，其衍生出来的 Tracing 记录更是不得了的量
- 一般来说Tracing系统都会在本地磁盘IO上做日志（最高效、也是最低的Cost），然后再通过本地 Agent 慢慢把文本日志数据发送到聚合服务器上，甚至可能在聚合服务器和本地的Agent之间还需要做消息队列，让聚合服务器慢慢消化巨量的消息
- Tracing在现在的业界是有标准的：OpenTracing，因此它不是很随意的日志/事件聚合，而是有格式要求的日志/事件聚合，这就是Tracing和Logging最大的不同



#### 日志

- Logging（日志）举例来说就是：废品回收站。各种各样的物品都会汇总进入到配品回收站里，然后经过分门别类归纳整理，成为各种可回收资源分别回收到商家那里。一般来说在大型系统中提到 Logging 说的都不是简单的日志，而是日志聚合系统
- 从本质上来说，Monitoring 和 Tracing 都是 Logging，Logging 是这三者中覆盖面最大的超集，而前两者则是其一部分的子集
- Logging 最麻烦的是，开发者也不会完全知道最后记录进入到日志系统里的一共会有哪些东西，只有在使用（检索）的时候才可能需要汇总查询总量中的一部分



#### 总结

- Monitoring 系统（Prometheus）从根本的需求和基本设计上就不可能支持 Tracing 和 Logging：低频 vs 高频、低量 vs 高量，其从设计到实现就只为了监控服务
- Tracing 系统（Jaeger）对提供的数据有格式要求，且处理方式和一般的 Logging 也不同，有更限定的应用范围
- Logging 系统（ELK）可以处理前两者的需求，但前两者的领域有更专业的工具就不推荐直接使用普通的日志聚合系统了，Logging 系统一般用来处理大型系统的日志聚合以及检索查询